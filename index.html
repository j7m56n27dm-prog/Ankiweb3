<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Anki - Spaced Repetition</title>
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Anki">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#1e1e1e">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/macos-anki.css">
    <link rel="stylesheet" href="css/ios-optimized.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Critical Loading Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            font-size: 13px;
            line-height: 1.4;
        }
        
        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Safe Area for iPhone Notch */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .safe-left {
            padding-left: env(safe-area-inset-left);
        }
        .safe-right {
            padding-right: env(safe-area-inset-right);
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            color: #888;
            font-size: 14px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Hide loading when app ready */
        .app-loaded .loading-screen {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Anki...</div>
    </div>
    
    <!-- Main App -->
    <div id="app">
        <!-- macOS Title Bar -->
        <div class="macos-titlebar safe-top">
            <div class="traffic-lights">
                <span class="traffic-light close"></span>
                <span class="traffic-light minimize"></span>
                <span class="traffic-light maximize"></span>
            </div>
            <div class="titlebar-title">Anki</div>
            <div class="titlebar-menu">
                <span class="menu-item">File</span>
                <span class="menu-item">Edit</span>
                <span class="menu-item">View</span>
                <span class="menu-item">Tools</span>
                <span class="menu-item">Help</span>
            </div>
            <div class="titlebar-controls">
                <button class="sync-btn" id="sync-btn">
                    <i class="fas fa-sync-alt"></i>
                    <span>Sync</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - Decks -->
            <div class="sidebar decks-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-layer-group"></i> DECKS</h3>
                    <button class="btn-icon" id="add-deck-btn" title="Add Deck">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="decks-list" id="decks-list">
                    <!-- Decks will be loaded here -->
                </div>
                <div class="sidebar-footer">
                    <div class="deck-stats-summary">
                        <div class="stat">
                            <span class="stat-label">Due:</span>
                            <span class="stat-value" id="total-due">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">New:</span>
                            <span class="stat-value" id="total-new">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center Content Area -->
            <div class="content-center">
                <!-- Toolbar -->
                <div class="anki-toolbar">
                    <div class="toolbar-left">
                        <button class="anki-btn primary" id="study-btn">
                            <i class="fas fa-play"></i>
                            <span>Study</span>
                        </button>
                        <button class="anki-btn" id="add-btn">
                            <i class="fas fa-plus"></i>
                            <span>Add</span>
                        </button>
                        <button class="anki-btn" id="browse-btn">
                            <i class="fas fa-table"></i>
                            <span>Browse</span>
                        </button>
                        <button class="anki-btn" id="stats-btn">
                            <i class="fas fa-chart-bar"></i>
                            <span>Stats</span>
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="global-search" placeholder="Search cards..." autocomplete="off">
                        </div>
                    </div>
                </div>
                
                <!-- Dynamic Content -->
                <div class="content-pane" id="content-pane">
                    <!-- Default content: Deck Overview -->
                    <div class="deck-overview active" id="deck-overview">
                        <div class="empty-state">
                            <i class="fas fa-cards fa-3x"></i>
                            <h2>Select a Deck</h2>
                            <p>Choose a deck from the sidebar to begin</p>
                        </div>
                    </div>
                    
                    <!-- Add Card View (hidden by default) -->
                    <div class="add-card-view" id="add-card-view">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <!-- Browse View (hidden by default) -->
                    <div class="browse-view" id="browse-view">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <!-- Stats View (hidden by default) -->
                    <div class="stats-view" id="stats-view">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar - Options -->
            <div class="sidebar options-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-sliders-h"></i> OPTIONS</h3>
                </div>
                <div class="options-content" id="options-content">
                    <!-- Options will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar safe-bottom">
            <div class="status-item">
                <span>Cards:</span>
                <strong id="status-cards">0</strong>
            </div>
            <div class="status-item">
                <span>Due:</span>
                <strong id="status-due">0</strong>
            </div>
            <div class="status-item">
                <span>New:</span>
                <strong id="status-new">0</strong>
            </div>
            <div class="status-spacer"></div>
            <div class="status-item" id="connection-status">
                <i class="fas fa-wifi"></i>
                <span>Online</span>
            </div>
        </div>
    </div>
    
    <!-- Study Modal -->
    <div class="modal-overlay" id="study-modal">
        <div class="study-window">
            <div class="study-header">
                <div class="study-deck-info">
                    <h3 id="study-deck-name">Deck</h3>
                    <div class="study-progress">
                        <span id="study-progress">0/0</span>
                    </div>
                </div>
                <button class="btn-close" id="close-study">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="study-content" id="study-content">
                <!-- Card will be displayed here -->
            </div>
            
            <div class="study-controls" id="study-controls">
                <!-- Answer buttons will appear here -->
            </div>
        </div>
    </div>
    
    <!-- Add Card Modal (alternative) -->
    <div class="modal-overlay" id="add-card-modal">
        <div class="modal-window">
            <div class="modal-header">
                <h3>Add Card</h3>
                <button class="btn-close" id="close-add-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="add-card-form">
                <!-- Form will be populated dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/database.js"></script>
    <script src="js/scheduler.js"></script>
    <script src="js/anki-engine.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
        
        // Prevent pull-to-refresh
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) e.preventDefault();
        }, { passive: false });
        
        // Prevent zoom on double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);
        
        // Detect iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            document.body.classList.add('ios');
        }
    </script>
</body>
</html>
